<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}My CRUD{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

</head>
<body>
    <!-- barra lateral -->
    {% include 'sidebar.html' %}
    <div class="contenido">
        {% block content %}{% endblock %}
    </div>
    
     <!-- Contenido -->
    <main>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12 d-flex justify-content-between align-items-center mb-3">
                    <h2>Reportes</h2>
                </div>

                <!--Formulario de reportes-->
                <div class="col-md-12 collapse mb-4" id="formReportes">
                    <div class="card">
                        <div class="card-header card-header col-md-12 d-flex justify-content-between align-items-center mb-3">
                                <span>Formulario de Reportes</span>
                                <button type="button" class="btn-close" data-bs-toggle="collapse" data-bs-target="#formReportes" aria-expanded="false" aria-controls="formReportes" aria-label="Close"></button>
                        </div>
                        <div class="card-body">
                            <form method="POST">
                               <div class="row mb-3">
                                    <div class="col-md-6 col-sm-12">
                                        <label for="alumno" class="form-label">Alumno</label>
                                        <select name="alumno" id="alumno" class="form-select">
                                            <option value="">Elige un Alumno</option>
                                            <option value="1">Mario</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 col-sm-12">
                                        <label for="fecha" class="form-label">Fecha del Reporte</label>
                                        <input id="fecha" name="fecha" type="date" class="form-control">
                                    </div>
                                    <div class="col-md-6 col-sm-12">
                                        <label for="descripcion" class="form-label">Descripcion</label>
                                        <textarea id="descripcion" name="descripcion" class="form-control" aria-label="With textarea"></textarea>
                                    </div>
                                    <div class="col-md-6 col-sm-12">
                                        <label for="accion" class="form-label">Accion Tomada</label>
                                        <textarea id="accion" name="accion" class="form-control" aria-label="With textarea"></textarea>
                                    </div>
                                    <div class="col-md-6 col-sm-12">
                                        <label for="status" class="form-label">Estado del reporte</label>
                                        <select name="status" id="status" class="form-select">
                                            <option value="">Elige un estado</option>
                                            <option value="AN">Sin Resolver</option>
                                            <option value="AC">Resuelto</option>
                                        </select>
                                    </div>
                               </div>
                               <div class="d-flex justify-content-end">
                                    <div class="btn-group" role="group" aria-label="Basic mixed styles example">
                                        <button type="submit" name="guardar" class="btn btn-success">Guardar</button>
                                    </div>    
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Reportes Resueltos -->
                <div class="col-md-12 collapse mb-4" id="ReportesResueltos">
                    <div class="card">
                        <div class="card-header col-md-12 d-flex justify-content-between align-items-center mb-3">
                                <span>Lista de reportes resueltos</span>
                                <button type="button" class="btn-close" data-bs-toggle="collapse" data-bs-target="#ReportesResueltos" aria-expanded="false" aria-controls="ReportesResueltos" aria-label="Close"></button>
                        </div>
                        <div class="card-body">
                            <table class="table table-hover table-borderless">
                                <thead>
                                    <tr>
                                        <th class="text-center"><b>ID del Alumno</b></th>
                                        <th class="text-center"><b>Fecha del Reporte</b></th>
                                        <th class="text-center"><b>Descripcion del Reporte</b></th>
                                        <th class="text-center"><b>Accion tomada</b></th>
                                        <th class="text-center"><b>Fecha de modificacion</b></th>
                                        <th class="text-center"><b>Accion</b></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for resuelto in resueltos%}
                                        <tr>
                                            <td class="text-center">{{ resuelto[1] }}</td>
                                            <td class="text-center">{{ resuelto[2].strftime('%d/%m/%Y') }}</td>
                                            <td class="text-center">{{ resuelto[3] }}</td>
                                            <td class="text-center">{{ resuelto[4] }}</td>
                                            <td class="text-center">{{ resuelto[5].strftime('%d/%m/%Y') }}</td>
                                            <td class="text-center">
                                                <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editModal"
                                                        data-id="{{ resuelto[0] }}" data-alumno="{{ resuelto[1] }}" data-fecha="{{ resuelto[2] }}" data-descripcion="{{ resuelto[3] }}" data-accion="{{ resuelto[4] }}" data-status="{{ resuelto[6] }}">
                                                        <ion-icon name="create"></ion-icon> Modificar
                                                </button>
                                                <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#eliminarModal"
                                                        data-id="{{ resuelto[0] }}" data-alumno="{{ resuelto[1] }}" data-fecha="{{ resuelto[2] }}" data-descripcion="{{ resuelto[3] }}" data-accion="{{ resuelto[4] }}" data-status="{{ resuelto[6] }}">
                                                        <ion-icon name="trash"></ion-icon> Eliminar
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reportes sin resolver --> 
                <div class="col-md-12 mb-4">
                    <div class="card">
                        <div class="card-header">Lista de reportes pendientes</div>
                        <div class="card-body">
                            <table class="table table-hover table-borderless">
                                <thead>
                                    <tr>
                                        <th class="text-center"><b>ID del Alumno</b></th>
                                        <th class="text-center"><b>Fecha del Reporte</b></th>
                                        <th class="text-center"><b>Descripcion del Reporte</b></th>
                                        <th class="text-center"><b>Accion tomada</b></th>
                                        <th class="text-center"><b>Fecha de modificacion</b></th>
                                        <th class="text-center"><b>Accion</b></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reporte in reportes%}
                                        <tr>
                                            <td class="text-center">{{ reporte[1] }}</td>
                                            <td class="text-center">{{ reporte[2] }}</td>
                                            <td class="text-center">{{ reporte[3] }}</td>
                                            <td class="text-center">{{ reporte[4] }}</td>
                                            <td class="text-center">{{ reporte[5].strftime('%d/%m/%Y') }}</td>
                                            <td class="text-center">
                                                <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editModal"
                                                        data-id="{{ reporte[0] }}" data-alumno="{{ reporte[1] }}" data-fecha="{{ reporte[2] }}" data-descripcion="{{ reporte[3] }}" data-accion="{{ reporte[4] }}" data-status="{{ reporte[6] }}">
                                                        <ion-icon name="create"></ion-icon> Modificar
                                                </button>
                                                <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#eliminarModal"
                                                        data-id="{{ reporte[0] }}" data-alumno="{{ reporte[1] }}" data-fecha="{{ reporte[2] }}" data-descripcion="{{ reporte[3] }}" data-accion="{{ reporte[4] }}" data-status="{{ reporte[6] }}">
                                                        <ion-icon name="trash"></ion-icon> Eliminar
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <div class="col-md-12 d-flex justify-content-between align-items-center mb-3">
                    <div></div>
                    <div>
                        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#ReportesResueltos" aria-expanded="false" aria-controls="ReportesResueltos">
                            <ion-icon name="eye"></ion-icon> Ver Reportes Resueltos 
                        </button>
                        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#formReportes" aria-expanded="false" aria-controls="formReportes">
                            <ion-icon name="add-circle"></ion-icon> Añadir Reporte 
                        </button>
                    </div>            
                </div>
            </div>
        </div>
    </main>

    <div class="menu">
        <ion-icon name="menu-outline"></ion-icon>
        <ion-icon name="close-outline"></ion-icon>
    </div>

    <!-- Modal editar -->
    <div class="modal-xl modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Modificar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST">
                        <div class="row mb-3">
                            <div class="col-md-6 col-sm-12">
                                <label for="id" class="form-label">ID</label>
                                <input id="id" name="id" type="text" class="form-control" readonly>
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <label for="alumno" class="form-label">Alumno ID</label>
                                <input type="text" id="alumno" name="alumno" class="form-control" readonly>
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <label for="fecha" class="form-label">Fecha del Reporte</label>
                                <input id="fecha" name="fecha" type="date" class="form-control">
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <label for="estado" class="form-label">Estado del reporte</label>
                                <select name="estado" id="estado" class="form-select">
                                    <option value="AN">Sin Resolver</option>
                                    <option value="AC">Resuelto</option>
                                </select>
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <label for="descripcion" class="form-label">Descripcion</label>
                                <textarea id="descripcion" name="descripcion" class="form-control" aria-label="With textarea"></textarea>
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <label for="accion" class="form-label">Accion Tomada</label>
                                <textarea id="accion" name="accion" class="form-control" aria-label="With textarea"></textarea>
                            </div>
                       </div>
                        <div class="d-flex justify-content-end">
                            <div class="btn-group" role="group" aria-label="Basic mixed styles example">
                                <button type="submit" name="modificar" class="btn btn-warning">Modificar</button>
                            </div>    
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal eliminar -->
    <div class="modal-xl modal fade" id="eliminarModal" tabindex="-1" aria-labelledby="eliminarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eliminarModalLabel">Eliminar</h5>
                </div>
                <div class="modal-body">
                    <form method="POST">
                        <div class="col-md-12">
                            <h5>¿Estás seguro de querer eliminar el Reporte?</h5>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6 col-sm-12">
                                <label for="id" class="form-label">ID</label>
                                <input id="id" name="id" type="text" class="form-control" readonly>
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <label for="alumno" class="form-label">Alumno ID</label>
                                <input type="text" id="alumno" name="alumno" class="form-control" readonly>
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <label for="fecha" class="form-label">Fecha del Reporte</label>
                                <input id="fecha" name="fecha" type="date" class="form-control" readonly>
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <label for="estado" class="form-label">Estado del Reporte</label>
                                <select name="estado" id="estado" class="form-select" disabled>
                                    <option value="AN">Sin Resolver</option>
                                    <option value="AC">Resuelto</option>
                                </select>
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <label for="descripcion" class="form-label">Descripción</label>
                                <textarea id="descripcion" name="descripcion" class="form-control" readonly></textarea>
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <label for="accion" class="form-label">Acción Tomada</label>
                                <textarea id="accion" name="accion" class="form-control" readonly></textarea>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="btn-group" role="group" aria-label="Basic mixed styles example">
                                <button type="submit" name="eliminar" class="btn btn-danger">Eliminar</button>
                                <button type="button" class="btn btn-success" data-bs-dismiss="modal" aria-label="Close">Cancelar</button>
                            </div>    
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
    <script>
        var editModal = document.getElementById('editModal');
        editModal.addEventListener('show.bs.modal', function (event) {
            // Botón que activó el modal
            var button = event.relatedTarget;

            // Extraer la información de los atributos data-*
            var id = button.getAttribute('data-id');
            var alumno = button.getAttribute('data-alumno');
            var fecha = button.getAttribute('data-fecha'); // El valor de la fecha
            var descripcion = button.getAttribute('data-descripcion');
            var accion = button.getAttribute('data-accion');
            var status = button.getAttribute('data-status');

            // Verificar si la fecha está en formato correcto (YYYY-MM-DD)
            let fechaFormateada = '';
            if (fecha) {
                // Intentar convertir si la fecha viene en formato DD/MM/YYYY
                if (fecha.includes('/')) {
                    var fechaParts = fecha.split('/');
                    if (fechaParts.length === 3) {
                        fechaFormateada = `${fechaParts[2]}-${fechaParts[1]}-${fechaParts[0]}`;
                    }
                } else {
                    // Si ya está en formato YYYY-MM-DD, la usamos directamente
                    fechaFormateada = fecha;
                }
            }

            // Obtener los elementos de los campos en el modal
            var modalId = editModal.querySelector('#id');
            var modalAlumno = editModal.querySelector('#alumno');
            var modalFecha = editModal.querySelector('#fecha');
            var modalDescripcion = editModal.querySelector('#descripcion');
            var modalAccion = editModal.querySelector('#accion');
            var modalStatus = document.getElementById('estado');


            // Actualizar el contenido del modal con los valores obtenidos
            modalId.value = id;
            modalAlumno.value = alumno;
            modalFecha.value = fechaFormateada || '';  // Asignar la fecha si está en formato correcto, de lo contrario dejar vacío
            modalDescripcion.value = descripcion;
            modalAccion.value = (accion === 'Sin acción tomada') ? '' : accion;
            modalStatus.value = status;
        });


        // Capturar el evento cuando se abre el modal de eliminar
        var eliminarModal = document.getElementById('eliminarModal');
        eliminarModal.addEventListener('show.bs.modal', function (event) {
            // Botón que disparó el modal
            var button = event.relatedTarget;
            
            // Extraer la información de los atributos data-*
            var id = button.getAttribute('data-id');
            var alumno = button.getAttribute('data-alumno');
            var fecha = button.getAttribute('data-fecha');
            var descripcion = button.getAttribute('data-descripcion');
            var accion = button.getAttribute('data-accion');
            var status = button.getAttribute('data-status');

            // Verificar si la fecha está en formato correcto (YYYY-MM-DD)
            let fechaFormateada = '';
            if (fecha) {
                // Intentar convertir si la fecha viene en formato DD/MM/YYYY
                if (fecha.includes('/')) {
                    var fechaParts = fecha.split('/');
                    if (fechaParts.length === 3) {
                        fechaFormateada = `${fechaParts[2]}-${fechaParts[1]}-${fechaParts[0]}`;
                    }
                } else {
                    // Si ya está en formato YYYY-MM-DD, la usamos directamente
                    fechaFormateada = fecha;
                }
            }
            
            // Obtener los elementos del modal
            var modalId = document.querySelector('#eliminarModal #id');
            var modalAlumno = document.querySelector('#eliminarModal #alumno');
            var modalFecha = document.querySelector('#eliminarModal #fecha');

            var modalDescripcion = document.querySelector('#eliminarModal #descripcion');
            var modalAccion = document.querySelector('#eliminarModal #accion');
            var modalStatus = document.querySelector('#eliminarModal #estado');
 

            // Actualizar el contenido del modal
            modalId.value = id;
            modalAlumno.value = alumno;
            modalFecha.value = fechaFormateada || '';
            modalDescripcion.value = descripcion;
            modalAccion.value = (accion === 'Sin acción tomada') ? '' : accion;
            modalStatus.value = status;
            
        });
    </script>

    
</body>
</html>